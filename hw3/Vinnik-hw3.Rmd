---
title: "22M04Vinnik-hw3"
author: "Vinnik Ekaterina"
date: "2024-03-13"
output: md_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# ДЗ 3. Кластеризация данных отзывов о путешествиях

## Винник Екатерина Петровна, 22.М04

Загрузим данные.

```{r data}
library(readr)
options(readr.show_col_types = FALSE)
review_data <- read_csv("data/tripadvisor_review.csv")
print(review_data)
```

## Анализ корреляций

В датасете есть 10 локаций (категорий), каждой категории пользователь, обладающий User ID, выставляет оценку от Excellent(4), Very Good(3), Average(2), Poor(1), and Terrible(0).

```{r}
review_data_mod <- as.data.frame(scale(review_data[,2:11]))
head(review_data_mod)
```
Проанализируем корреляции отзывов о различных локациях путешествий.

```{r}
library(ggcorrplot)

corr_scaled <- round(cor(review_data_mod),1)

ggcorrplot(corr_scaled, hc.order = TRUE, 
           type = "lower", 
           lab = TRUE, 
           lab_size = 3, 
           method="circle", 
           colors = c("tomato2", "white", "springgreen3"), 
           title="Correlogram of tripAdvisor reviews Data", 
           ggtheme=theme_bw)

```

Также построим матрицу корреляций Пирсона. Видно, что обе матрицы согласуются между собой -- сильно коррелируют признаки Category 7 и Category 3 (коэффициент корреляции составляет 0.8), Category 6 и Category 5 (коэффициент корреляции составляет 0.6), Category 7 и Category 6 (коэффициент корреляции составляет 0.4).
```{r}
corrplot::corrplot(cor(review_data_mod, method="pearson"))
```

Таким образом, в имеющемся датасете присутствуют коррелированные признаки, определим те, которые наиболее коррелированы с остальными.

```{r}
a<-caret::findCorrelation(corr_scaled, cutoff = 0.59, verbose = T)

print("---Column name we want to remove---")
colnames(review_data_mod)[a]
```
Так как признаки Category 7 и Category 6 сильно коррелируют с остальными, их можно удалить из датасета. Удалим их из датасета.
```{r}
library(dplyr)
review_data_mod <- as.data.frame(review_data_mod) %>% select(-"Category 6", -"Category 7")
```
Таким образом, при дальнейшем анализе будет использоваться следующий датасет без признаков Category 6, Category 7.
```{r}
head(review_data_mod)
```
## Определение оптимального числа кластеров
Построим графики средней ширины силуэтов и WSS, чтобы определить наличие кластеров в датасете. 

```{r}
library(factoextra)
fviz_nbclust(review_data_mod, kmeans, method="wss")
fviz_nbclust(review_data_mod, kmeans, method="silhouette")
```


Графики средней ширины силуэтов и WSS позволяют предположить наличие 2 или 5 кластеров в датасете.

## Разбиение на кластеры

Визуализируем кластеры в данных, определяемые алгоритмом KMeans для 2 и 5 кластеров, полученных при анализе ранее.

```{r}
clus_res_2 <- kmeans(review_data_mod, 2)
fviz_cluster(clus_res_2, review_data_mod, stand = FALSE,
geom = "point", ggtheme = theme_bw())
```

```{r}
clus_res_5 <- kmeans(review_data_mod, 5)
fviz_cluster(clus_res_5, review_data_mod, stand = FALSE,
geom = "point", ggtheme = theme_bw())
```
## Устойчивость кластеров

Определим оптимальное число кластеров при помощи анализа устойчивости кластеров (на основе формирования подвыборок из исходной выборки).

```{r }
library(fpc)
clboo_res_2 <- fpc::clusterboot(review_data_mod,B=100,bootmethod=c("boot"),clustermethod=kmeansCBI,k=2)
clboo_res_4 <- fpc::clusterboot(review_data_mod,B=100,bootmethod=c("boot"),clustermethod=kmeansCBI,k=4)
clboo_res_5 <- fpc::clusterboot(review_data_mod,B=100,bootmethod=c("boot"),clustermethod=kmeansCBI,k=5)
clboo_res_6 <- fpc::clusterboot(review_data_mod,B=100,bootmethod=c("boot"),clustermethod=kmeansCBI,k=6)
```

```{r}
clboo_res_2
```
```{r}
clboo_res_4
```

```{r}
clboo_res_6
```

```{r}
clboo_res_5
```
Таким образом, видно, что 2  и 5 кластеров устойчивы, а 3 и 6 -- нет. Разбиение данных на 5 кластеров более точно, поэтому будем при анализе групп пользователей сервиса использовать его.

## Интерпретация выделенных кластеров (описание групп пользователей сервиса TripAdvisor со схожими интересами в терминах предметной области)

Проанализируем 5 групп пользователей, на которые были разбиты данные с помощью кластеризации. Анализ нескольких признаков (категорий) вместе возможен, так как все признаки измеряются в одной шкале отзывов от 0 до 4.

## Табличка со средними оценками, которые выставляют пользователи различным локациям
Рассмотрим средние оценки в каждой группе пользователей, которые они выставляют различным локациям. В рассмотрении используется исходный датасет:

```{r}
review_data_clusters <- review_data %>% mutate(cluster = as.factor(clus_res_5$cluster))

summary_tab <- review_data_clusters %>% group_by(cluster) %>% summarise(
  mean_cat1=mean(`Category 1`),
  mean_cat2=mean(`Category 2`),
  mean_cat3=mean(`Category 3`),
  mean_cat4=mean(`Category 4`),
  mean_cat5=mean(`Category 5`),
  mean_cat6=mean(`Category 6`),
  mean_cat7=mean(`Category 7`),
  mean_cat8=mean(`Category 8`),
  mean_cat9=mean(`Category 9`),
  mean_cat10=mean(`Category 10`))

print(summary_tab, width = Inf)
```

Из таблицы видно, что:

- пользователи каждой группы высоко оценили категорию 7 -- средняя оценка для этой локации в каждой группе превышает 3
- также видно, что пользователи каждой группы низко оценили категорию 4 -- средняя оценка для этой локации в каждой группе не достигает 1
- пользователи четвертой группы (кластер 4) выше остальных оценили категорию 1 -- среднее значение отзыва составило 1.53, тогда как в остальных группах среднее значение отзыва не достигает 0.9
- пользователи второй группы (кластер 2) выше остальных оценили категорию 6 -- среднее значение отзыва составило 2.2, тогда как в остальных группах среднее значение отзыва не достигает 1.9
- пользователи второй группы (кластер 2) выше остальных оценили категорию 5 -- среднее значение отзыва составило 1.28, тогда как в остальных группах среднее значение отзыва не достигает 1.0
- пользователи второй группы (кластер 2) выше остальных оценили категорию 3 -- среднее значение отзыва составило 1.95, тогда как в остальных группах среднее значение отзыва не достигает 1.0
- в целом, можно отметить, что пользователи второй группы склонны ставить оценки различным локациям выше, чем пользователи остальных групп

## Ящики с усами

```{r}
library(tidyr)
review_data_clusters %>% select(`Category 1`,`Category 2`,`Category 3`,`Category 4`, cluster) %>% pivot_longer(1:4, names_to = "feature", values_to = "vals") %>%
  ggplot(aes(x=feature, y=vals, fill = as.factor(cluster))) + geom_boxplot()
```

```{r}
library(tidyr)
review_data_clusters %>% select(`Category 5`,`Category 8`,`Category 9`,`Category 10`, cluster) %>% pivot_longer(1:4, names_to = "feature", values_to = "vals") %>%
  ggplot(aes(x=feature, y=vals, fill = as.factor(cluster))) + geom_boxplot()
```

```{r}
library(tidyr)
review_data_clusters %>% select(`Category 6`,`Category 7`, cluster) %>% pivot_longer(1:2, names_to = "feature", values_to = "vals") %>%
  ggplot(aes(x=feature, y=vals, fill = as.factor(cluster))) + geom_boxplot()
```

Из графиков ящиков с усами можно заключить, что:

- оценки пользователей группы 2 существенно выше остальных групп для категории 6, категории 5, категории 3.
- части пользователей группы 3 меньше остальных групп понравились категории 4, 6, 9. 
- части пользователей группы 3 больше остальных понравилась категория 10 -- оценки всех пользователей этой группы для категории 10 превышают 3, тогда как оценки всех остальных пользователей не превышают 3.
- категории 3 и 5 пользователи всех групп оценивают по-разному (в каждой группе диапазон значений оценок категории большой, что демонстрируется вытянутыми ящиками с усами).
- оценки категорий 7, 8 и 4 имеют маленький разброс (не сильно отличаются). Оценки категории 7 почти константны.

## Попарный статистический вывод (t-критерий) с интерпретацией

Проверим, совпадает ли в среднем мнение пользователей различных групп в датасете о категории 8. Воспользуемся статистическим выводом (t-критерием).
```{r}
library(ggplot2)

ggplot(review_data_clusters, aes(y=`Category 8`, fill = as.factor(cluster))) + geom_boxplot()
```

*Нулевая гипотеза*: средние значения признака Category 8 одинаковы между кластерами.
```{r}
pairwise.t.test(review_data_clusters$`Category 8`, review_data_clusters$cluster)
```
Из результатов t-критерия видно, что разница между средним значением оценки Category 8 пользователей 1 и 2 кластера не является статистически значимой. Разница между средним значением оценки Category 8 пользователей других пар кластеров статистически значима, то есть, средние значения между остальными кластерами не равны.

Это же подтверждается ящиком с усами, изображенным выше -- из него видно, что средние значения оценки категории 8 для кластеров 3, 4, 5, различны и превышают среднее значение оценки категории 8 для  кластера 2.


*Нулевая гипотеза*: средние значения признаков Category 4 и Category 8 одинаковы.
```{r}
summary(aov(review_data_clusters$`Category 4` ~ review_data_clusters$`Category 8`))
```
Полученное p-значение ниже уровня значимости 0.05, значит гипотеза о равенстве признаков отклоняется.

## Характеристика кластеров

Таким образом, из анализа кластеров можно сделать следующие выводы:

- Пользователи кластера 2 склонны ставить более высокие оценки и выше всех остальных оценили категории 3, 5, 6.
- Пользователи кластера 3 склонны ставить более низкие оценки, но некоторые пользователи из кластера значительно выше остальных оценили категорию 10. Ниже всех остальных они оценили категории 4, 6, 9.
- Пользователи кластера 1 склонны ставить более низкие оценки, но некоторые пользователи этой группы выше всех остальных оценили категорию 2. Ниже всех остальных они оценили категории 1, 3, 5.
- Некоторые пользователи из кластера 4 выше всех остальных оценили категорию 1.
- Некоторые пользователи из кластера кластера 5 выше всех остальных оценили категорию 9.
